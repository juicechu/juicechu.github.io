<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Archives: 2013 | juice 博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="zhuxi.me">
<meta property="og:type" content="website">
<meta property="og:title" content="juice 博客">
<meta property="og:url" content="http://juicechu.zhuxi.me/archives/2013/index.html">
<meta property="og:site_name" content="juice 博客">
<meta property="og:description" content="zhuxi.me">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="juice 博客">
<meta name="twitter:description" content="zhuxi.me">
  
    <link rel="alternative" href="/atom.xml" title="juice 博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="null" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">juice</a></h1>
		</hgroup>

		
		<p class="header-subtitle">新的开始</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						<li>友情链接</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="/#" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="/#" title="weibo">weibo</a>
					        
								<a class="rss" target="_blank" href="/#" title="rss">rss</a>
					        
								<a class="zhihu" target="_blank" href="/#" title="zhihu">zhihu</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">奥巴马的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">卡卡的美丽传说</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">本泽马的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">吉格斯的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">习大大大不同</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">托蒂的博客</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">我是谁，我从哪里来，我到哪里去？我就是我，是颜色不一样的吃货…</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">juice</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="null" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">juice</h1>
			</hgroup>
			
			<p class="header-subtitle">新的开始</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="/#" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="/#" title="weibo">weibo</a>
			        
						<a class="rss" target="_blank" href="/#" title="rss">rss</a>
			        
						<a class="zhihu" target="_blank" href="/#" title="zhihu">zhihu</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap">
  
    <article id="post-2013-12-php-fsock-rsync" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2013/12/26/2013-12-php-fsock-rsync/" class="article-date">
  	<time datetime="2013-12-26T11:27:00.000Z" itemprop="datePublished">2013-12-26</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2013/12/26/2013-12-php-fsock-rsync/">PHP中使用fsock实现伪异步</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在Web开发中，我们经常会遇到这样一个场景：用户发起一个请求，处理这个请求的业务很简单，可能几毫秒或者几十毫秒就能完成；但是这个请求会影响另外一个业务系统，所以我们在处理完用户的请求后，不得不发起一个新的后台请求到相关的业务系统，而相关的业务系统响应我们的后台请求可能非常慢，这样就会延长我们的整个响应时间。</p>
<p>  实例：我们的用户头像会保存到CDN，当用户更换头像的时候，上传写入可以很快的完成，但是调用CDN的purge接口可能要很久（好几秒），这样就会导致整个上传过程耗时很长。</p>
<p>当然，要解决这个问题有很多办法；比如把purge接口的请求丢给消息队列，后台计划任务不停地消费消息队列发起purge请求；如果这么做确实可以解决问题，但是把整体架构复杂化了。</p>
<p>不用消息队列，很多人就会想到用异步；但是项目使用的是PHP，它是顺序执行，不支持异步的，怎么办？</p>
<p>拜读Laruence早期的文章：</p>
<p>《PHP实现异步调用方法研究》<br>《使用fscok实现异步调用PHP》<br>根据文章中的介绍，果断采用fsockopen的方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">asyncGet</span><span class="params">(<span class="variable">$url</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="variable">$parts</span> = parse_url(<span class="variable">$url</span>);</span><br><span class="line">    <span class="variable">$fp</span> = fsockopen(</span><br><span class="line">        <span class="variable">$parts</span>[<span class="string">'host'</span>],</span><br><span class="line">        <span class="keyword">isset</span>(<span class="variable">$parts</span>[<span class="string">'port'</span>]) ? <span class="variable">$parts</span>[<span class="string">'port'</span>] : <span class="number">80</span>,</span><br><span class="line">        <span class="variable">$errno</span>, <span class="variable">$errstr</span>, <span class="number">3</span></span><br><span class="line">    );</span><br><span class="line">    <span class="variable">$out</span> = <span class="string">"GET "</span> . <span class="variable">$parts</span>[<span class="string">'path'</span>] . <span class="string">" HTTP/1.1\r\n"</span>;</span><br><span class="line">    <span class="variable">$out</span> .= <span class="string">"Host: "</span> . <span class="variable">$parts</span>[<span class="string">'host'</span>] . <span class="string">"\r\n"</span>;</span><br><span class="line">    <span class="variable">$out</span> .= <span class="string">"Connection: Close\r\n\r\n"</span>;</span><br><span class="line">    fwrite(<span class="variable">$fp</span>, <span class="variable">$out</span>);</span><br><span class="line">    fclose(<span class="variable">$fp</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$start</span> = microtime(<span class="keyword">true</span>);</span><br><span class="line">asyncGet(</span><br><span class="line">    <span class="string">'http://cdn.ljf.me/purge.php'</span></span><br><span class="line">);</span><br><span class="line"><span class="variable">$end</span> = microtime(<span class="keyword">true</span>);</span><br><span class="line"><span class="variable">$cost</span> = <span class="variable">$end</span> - <span class="variable">$start</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"purge cdn cost: $cost s\n"</span>;</span><br></pre></td></tr></table></figure>
<p>问题来了，无论如何发送请求，服务器都没有正常地清洗缓存（直接输入url访问是可以正常清洗的，排除purge接口本身的问题）。</p>
<p>用WireShark抓到数据包来看，请求确实是有发出，也是正常的。</p>
<p>为什么请求有发出，但是服务器并没有进行清洗CDN工作，问题可能出现在哪里？</p>
<p>本地搭出一个测试环境。使用相同的脚本发完请求后，查看php-fpm的access日志没有找到刚才的请求，但是nginx的access是有这个请求的，状态码是499。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1 - - [18/Dec/2013:11:57:57 +0800] "GET /purge.php HTTP/1.1" 499 0 "-" "-" "-"</span><br></pre></td></tr></table></figure>
<p>在HTTP协议中没有直接定义499的状态码，这个状态码是nginx指定的。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/* from ngx_http_request.h */</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"> * HTTP does not define the code for the case when a client closed</span><br><span class="line"> * the connection while we are processing its request so we introduce</span><br><span class="line"> * own code to log such situation when a client has closed the connection</span><br><span class="line"> * before we even try to send the HTTP header to it</span><br><span class="line"> */</span><br><span class="line">#define NGX_HTTP_CLIENT_CLOSED_REQUEST     499</span><br></pre></td></tr></table></figure>
<p>nginx对499的定义是”client has closed connection”，并且在这些情况下会返回这个状态码：</p>
<p>upstream 在收到读写事件处理之前时发现连接不可用。<br>server处理请求未结束，而client提前关闭了连接。<br>upstream出错，执行next_upstream时发现连接不可用。<br>现在的问题是：我们要等nginx的upstream处理完并且把请求交给fastcgi之后，才能主动关闭连接，否则就不能正常的清洗CDN的缓存了。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">asyncGet</span><span class="params">(<span class="variable">$url</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="variable">$parts</span> = parse_url(<span class="variable">$url</span>);</span><br><span class="line">    <span class="variable">$fp</span> = fsockopen(</span><br><span class="line">        <span class="variable">$parts</span>[<span class="string">'host'</span>],</span><br><span class="line">        <span class="keyword">isset</span>(<span class="variable">$parts</span>[<span class="string">'port'</span>]) ? <span class="variable">$parts</span>[<span class="string">'port'</span>] : <span class="number">80</span>,</span><br><span class="line">        <span class="variable">$errno</span>, <span class="variable">$errstr</span>, <span class="number">3</span></span><br><span class="line">    );</span><br><span class="line">    <span class="variable">$out</span> = <span class="string">"GET "</span> . <span class="variable">$parts</span>[<span class="string">'path'</span>] . <span class="string">" HTTP/1.1\r\n"</span>;</span><br><span class="line">    <span class="variable">$out</span> .= <span class="string">"Host: "</span> . <span class="variable">$parts</span>[<span class="string">'host'</span>] . <span class="string">"\r\n"</span>;</span><br><span class="line">    <span class="variable">$out</span> .= <span class="string">"Connection: Close\r\n\r\n"</span>;</span><br><span class="line">    fwrite(<span class="variable">$fp</span>, <span class="variable">$out</span>);</span><br><span class="line">    usleep(<span class="number">10000</span>);</span><br><span class="line">    fclose(<span class="variable">$fp</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一个不安全的做法是在fclose之前，让当前的进程先睡眠一段时间；我这里设置为10毫秒，这10毫秒的延迟对我完成整个请求的影响不大，同时我也认为nginx一定能在10毫米内把请求转到fastcgi去执行。这个时间间隔很难把握，不能保证php一定有执行到。</p>
<p>这种方式并不是真正的异步，只是很取巧的强制关闭连接而不等待服务器端响应。所以在Laruence的那2篇文章中，有2个问题：</p>
<p>PHP使用fsock不能叫做异步，只是伪异步。<br>fwrite之后马上执行fclose，nginx会直接返回499。<br>Laruence这2篇博文都是08年写的，不知道当时是不是用apache做的测试。因为没有使用apache的场景，所以也就不打算用apache再验证一次。</p>
<p>转载自：<a href="http://ljf.me/archives/use-sock-to-implement-the-async-in-php" target="_blank" rel="external">http://ljf.me/archives/use-sock-to-implement-the-async-in-php</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/转载/">转载</a><a class="article-category-link" href="/categories/转载/PHP/">PHP</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-2013-11-nginx-fpm-file-not-find" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2013/11/22/2013-11-nginx-fpm-file-not-find/" class="article-date">
  	<time datetime="2013-11-22T02:29:00.000Z" itemprop="datePublished">2013-11-22</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2013/11/22/2013-11-nginx-fpm-file-not-find/">ubuntu下配置nginx+php-fpm的file not find问题</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>第一种情况下sudo vim /etc/nginx/sites-enable/default下配置</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">location</span> <span class="regexp">~ \.php$</span> &#123;</span><br><span class="line">    <span class="title">try_files</span> <span class="variable">$uri</span> =<span class="number">404</span>;</span><br><span class="line">    <span class="title">fastcgi_split_path_info</span><span class="regexp"> ^(.+\.php)(/.+)$</span>;</span><br><span class="line">    <span class="title">fastcgi_pass</span> <span class="url">unix:/var/run/php5-fpm.sock</span>;</span><br><span class="line">    <span class="title">fastcgi_index</span> index.php;</span><br><span class="line">    <span class="title">fastcgi_read_timeout</span> <span class="number">300</span>;</span><br><span class="line">    <span class="title">fastcgi_param</span> SCRIPT_FILENAME <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">    <span class="title">include</span> fastcgi_params;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第二种情况就是 /etc/php5/fpm/pool.d/www.conf</p>
<p>文件配置下user = XXX必须与你/etc/nginx/nginx.conf的配置下user =XXX 一置，而且XXX必须是有访问权限。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/原创/">原创</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-2013-11-phpmyadmin-mcrypt-extension-is-missing" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2013/11/22/2013-11-phpmyadmin-mcrypt-extension-is-missing/" class="article-date">
  	<time datetime="2013-11-22T02:21:00.000Z" itemprop="datePublished">2013-11-22</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2013/11/22/2013-11-phpmyadmin-mcrypt-extension-is-missing/">phpmyadmin页面提示mcrypt extension is missing错误解决</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>这是一个mcrypt文件位置错误的bug</p>
<p>详细的bug信息请参考以下网址：</p>
<p><a href="https://bugs.launchpad.net/ubuntu/+source/phpmyadmin/+bug/1236035" target="_blank" rel="external">https://bugs.launchpad.net/ubuntu/+source/phpmyadmin/+bug/1236035</a></p>
<p>#mv -i /etc/php5/conf.d/mcrypt.ini /etc/php5/mods-available/</p>
<p>#sudo php5enmod mcrypt</p>
<p>#/etc/init.d/apache2 restart</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/原创/">原创</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-2013-10-multi-process-write" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2013/10/27/2013-10-multi-process-write/" class="article-date">
  	<time datetime="2013-10-27T13:17:00.000Z" itemprop="datePublished">2013-10-27</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2013/10/27/2013-10-multi-process-write/">多进程写文件</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 多进程写文件</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">write_file</span><span class="params">(<span class="variable">$filename</span>, <span class="variable">$content</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="variable">$lock</span> = <span class="variable">$filename</span> . <span class="string">'.lck'</span>;<span class="comment">//与文件名关联的加锁文件</span></span><br><span class="line">    <span class="variable">$write_length</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>( file_exists(<span class="variable">$lock</span>) ) &#123;<span class="comment">//判断是否已存在该锁，存在则证明已有进程在写文件，休眠100毫秒</span></span><br><span class="line">            usleep(<span class="number">100</span>);<span class="comment">//休眠100毫秒</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            touch(<span class="variable">$lock</span>);<span class="comment">//加锁</span></span><br><span class="line">            <span class="variable">$write_length</span> = file_put_contents(<span class="variable">$filename</span>, <span class="variable">$content</span>, FILE_APPEND);<span class="comment">//写文件</span></span><br><span class="line">            <span class="keyword">break</span>;<span class="comment">//退出循环</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>( file_exists(<span class="variable">$lock</span>) ) &#123;</span><br><span class="line">        unlink(<span class="variable">$lock</span>);<span class="comment">//解锁</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$write_length</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/原创/">原创</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-2013-10-php-foreach-object" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2013/10/27/2013-10-php-foreach-object/" class="article-date">
  	<time datetime="2013-10-27T13:12:00.000Z" itemprop="datePublished">2013-10-27</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2013/10/27/2013-10-php-foreach-object/">使对象可以像数组一样进行foreach循环，要求属性必须是私有。(Iterator模式的PHP5实现，写一类实现Iterator接口)</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>使对象可以像数组一样进行foreach循环，要求属性必须是私有。</p>
<p>刚接触到题的时候，我也没有考虑到Iterator模式，试了几个一般想法，失败以后。。。。就直接去翻看了foreach的源码实现，期望发现foreach处理对象的时候是否有什么特殊性，可以做为突破口。</p>
<p>跟踪了半天以后发现了核心逻辑中的一个奇怪的switch:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> (zend_iterator_unwrap(<span class="built_in">array</span>, &amp;iter TSRMLS_CC)) &#123;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">case</span> ZEND_ITER_INVALID:</span><br><span class="line">               .....</span><br><span class="line">               <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> ZEND_ITER_PLAIN_OBJECT: &#123;</span><br><span class="line">                ......</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">     <span class="keyword">case</span> ZEND_ITER_PLAIN_ARRAY:</span><br><span class="line">            .....</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ZEND_ITER_OBJECT:</span><br><span class="line">            ......</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从这个结构，我们可以看到，对象分为ZEND_ITER_OBJECT和ZEND_ITER_PLAIN_OBJECT, 这是什么意思呢？</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ZEND_API <span class="keyword">enum</span> zend_object_iterator_kind <span class="title">zend_iterator_unwrap</span><span class="params">(</span><br><span class="line">    zval *array_ptr, zend_object_iterator **iter TSRMLS_DC)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (Z_TYPE_P(array_ptr)) &#123;</span><br><span class="line">        <span class="keyword">case</span> IS_OBJECT:</span><br><span class="line">            <span class="keyword">if</span> (Z_OBJ_HT_P(array_ptr) == &amp;iterator_object_handlers) &#123;</span><br><span class="line">                *iter = (zend_object_iterator *)zend_object_store_get_object(array_ptr TSRMLS_CC);</span><br><span class="line">                <span class="keyword">return</span> ZEND_ITER_OBJECT;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (HASH_OF(array_ptr)) &#123;</span><br><span class="line">                <span class="keyword">return</span> ZEND_ITER_PLAIN_OBJECT;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> ZEND_ITER_INVALID;</span><br><span class="line">        <span class="keyword">case</span> IS_ARRAY:</span><br><span class="line">            <span class="keyword">if</span> (HASH_OF(array_ptr)) &#123;</span><br><span class="line">                <span class="keyword">return</span> ZEND_ITER_PLAIN_ARRAY;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> ZEND_ITER_INVALID;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> ZEND_ITER_INVALID;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这就要讲到PHP的内置接口Iterator了，PHP5开始支持了接口， 并且内置了Iterator接口， 所以如果你定义了一个类，并实现了Iterator接口，那么你的这个类对象就是ZEND_ITER_OBJECT,否则就是 ZEND_ITER_PLAIN_OBJECT.</p>
<p>对于ZEND_ITER_PLAIN_OBJECT的类，foreach会通过HASH_OF获取该对象的默认属性数组，然后对该数组进行foreach.<br>而对于ZEND_ITER_OBJECT的类对象，则会通过调用对象实现的Iterator接口相关函数来进行foreach， 所以， 对于这道笔试题， 可以作出如下的答案：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">sample</span> <span class="keyword">implements</span> <span class="title">Iterator</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$_items </span>= <span class="keyword">array</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>);</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                  ;<span class="comment">//void</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">rewind</span><span class="params">()</span> </span>&#123; reset(<span class="variable">$this</span>-&gt;_items); &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">current</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> current(<span class="variable">$this</span>-&gt;_items); &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">key</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> key(<span class="variable">$this</span>-&gt;_items); &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">next</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> next(<span class="variable">$this</span>-&gt;_items); &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">valid</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> ( <span class="variable">$this</span>-&gt;current() !== <span class="keyword">false</span> ); &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$sa </span>= <span class="keyword">new</span> sample();</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$sa as </span><span class="variable">$key </span>=&gt; <span class="variable">$val</span>)&#123;</span><br><span class="line">    <span class="keyword">print</span> <span class="variable">$key </span>. <span class="string">"=&gt;"</span> .<span class="variable">$val</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>转载：<a href="http://www.laruence.com/2008/10/31/574.html" target="_blank" rel="external">http://www.laruence.com/2008/10/31/574.html</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/转载/">转载</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-2013-10-apache-rewrite-403" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2013/10/22/2013-10-apache-rewrite-403/" class="article-date">
  	<time datetime="2013-10-21T16:24:00.000Z" itemprop="datePublished">2013-10-22</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2013/10/22/2013-10-apache-rewrite-403/">apache rewriteEngine开启后出现403</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>apache伪静态URL配置RewriteEngine on出现403错误</p>
<p>解决方案：<br>1.在apache配置文件httpd.conf中，修改两项配置: Options FollowSymLinks、AllowOverride All。<br>2.把Options Indexes注释掉，也就是前面加个“#”，变成#Options Indexes</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/原创/">原创</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-2013-10-process-port-80-occupancy" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2013/10/21/2013-10-process-port-80-occupancy/" class="article-date">
  	<time datetime="2013-10-21T10:50:00.000Z" itemprop="datePublished">2013-10-21</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2013/10/21/2013-10-process-port-80-occupancy/">80端口被PID为4的系统进程所占用</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>装apache的时候80端口被PID为4的系统进程所占用 由于工作中需要直接从MySQL后台读取数据，所以安装了PHPnow，装的过程中提示Apache安装失败，80端口被占用。 在cmd中输入netstat –ano命令，发现80端口被一个PID为4的服务所占用，打开任务管理器，发现PID为4的进程为系统进程，其描述信息为NT Kernel &amp; System，在服务里面又找不到PID为4的服务，所以没法停掉服务。 这种情况基本上就是谷歌和度娘的事了，搜出来的结果大部分不靠谱，要么说迅雷等下载软件会占用80端口，要么说IIS占用了该端口。事实上，我机器上这些服务都没启动。那么究竟是什么原因呢？还好，偶然间看到一个页面说MS SQL Server的报表服务会占用80端口（写日志的时候已经找不到链接了，恕未引用），于是打开windows服务，找到SQL Server Reporting Services (MYSQLSERVER)，把它停掉，再安装PHPnow，发现果然能顺利安装。 以后遇到类似问题，关掉SQL Server Reporting Services (MYSQLSERVER)也可以作为一种尝试了。</p>
<p>一些查看端口占用和关闭端口的命令，已443端口为例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">netstat -ano|findstr <span class="string">"443"</span> //搜索<span class="number">443</span>端口占用情况，并找到进程ID</span><br><span class="line">TCP <span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">443</span> <span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">0</span> LISTENING <span class="number">720</span> //找到PID为<span class="number">720</span></span><br><span class="line">UDP <span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">59443</span> *:* <span class="number">7584</span></span><br><span class="line">-----------------------------------------------</span><br><span class="line">tasklist|findstr <span class="string">"720"</span> //查找PID为<span class="number">720</span>对应的进程名</span><br><span class="line">QQDownload.exe <span class="number">720</span> Console <span class="number">1</span> <span class="number">56</span>,<span class="number">156</span> K //找到是QQ旋风占用，结束掉进程。OK</span><br></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/原创/">原创</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-2013-10-text-similarity-algorithm-php" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2013/10/03/2013-10-text-similarity-algorithm-php/" class="article-date">
  	<time datetime="2013-10-02T17:09:00.000Z" itemprop="datePublished">2013-10-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2013/10/03/2013-10-text-similarity-algorithm-php/">用余弦定理实现文本相似度算法</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>续上一篇文章的算法，这次自己改成PHP版本，当然如果有优化的地方请指出，以便大家学习。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">&lt;?php</span></span><br><span class="line">header(<span class="string">'Content-Type: text/html; charset=UTF-8'</span>);</span><br><span class="line"><span class="variable">$text1</span> = <span class="string">&lt;&lt;&lt;EOF</span><br><span class="line">Fragment A (By Rousseau)：</span><br><span class="line">À l’instant, au lieu de la personne particulière de chaque contractant, cet acte d’association produit un Corps moral et collectif, composé d’autant de membres que l’assemblée a de voix, lequel reçoit de ce même acte son unité, son moi commun, sa vie et sa volonté. Cette personne publique, qui se forme ainsi par l’union de toutes les autres, prenait autrefois le nom de Cité , et prend maintenant celui de République ou de Corps politique: lequel est appelé par ses membres État quand il est passif, Souverain quand il est actif, Puissance en le comparant à ses semblables. À l’égard des associés, ils prennent collectivement le nom de peuple, et s’appellent en particulier citoyens, comme participant à l’autorité souveraine, et sujets, comme soumis aux lois de l’État. (Rousseau, Du contrat social, I.6)</span><br><span class="line">EOF;</span></span><br><span class="line"><span class="variable">$text2</span> = <span class="string">&lt;&lt;&lt;EOF</span><br><span class="line">Fragment B (By Hobbes)：</span><br><span class="line">Art goes yet further, imitating that Rationall and most excellent worke of Nature, Man. For by Art is created that great LEVIATHAN called a COMMON-WEALTH, or STATE, (in latine CIVITAS) which is but an Artificiall Man; though of greater stature and strength than the Naturall, for whoseprotection and defence it was intended; and in which, the Soveraignty is an Artificiall Soul, as giving life and motion to the whole body; The Magistrates, and other Officers of Judicature and Execution, artificiall Joynts; Reward and Punishment (by which fastned to the seat of the Soveraignty, every joynt and member is moved to performe his duty) are the Nerves, that do the same in the Body Naturall; The Wealth and Riches of all the particular members, are the Strength; Salus Populi (the Peoples Safety) its Businesse; Counsellors, by whom all things needfull for it to know, are suggested unto it, are the Memory; Equity and Lawes, an artificiall Reason and Will; Concord, Health; Sedition, Sicknesse; and Civill War, Death. Lastly, the Pacts and Covenants, by which the parts of this Body Politique were at first made, set together, and united, resemble that Fiat, or the Let Us Make Man, pronounced by God in the Creation. (Hobbes, Leviathan, "Introduction"）</span><br><span class="line">EOF;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> similarAlgorithm(<span class="variable">$text1</span> , <span class="variable">$text2</span>);</span><br><span class="line"><span class="comment">/*</span><br><span class="line">* 文本相似度匹配</span><br><span class="line">* <span class="doctag">@author</span> juice</span><br><span class="line">* <span class="doctag">@param</span> text1 匹配文本1</span><br><span class="line">* <span class="doctag">@param</span> text2 匹配文本2</span><br><span class="line">* <span class="doctag">@return</span> double 返回相似度(余弦值)</span><br><span class="line">*/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">similarAlgorithm</span><span class="params">(<span class="variable">$text1</span> = <span class="string">''</span> , <span class="variable">$text2</span> = <span class="string">''</span>)</span></span>&#123;</span><br><span class="line">    <span class="variable">$charset</span> = <span class="string">'UTF-8'</span> ;</span><br><span class="line">    <span class="variable">$text1Array</span> = mbStringToArray(<span class="variable">$text1</span> , <span class="variable">$charset</span> ,<span class="keyword">TRUE</span>);</span><br><span class="line">    <span class="variable">$text2Array</span> = mbStringToArray(<span class="variable">$text2</span> , <span class="variable">$charset</span> ,<span class="keyword">TRUE</span>);</span><br><span class="line">    <span class="variable">$textSumArray</span> = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$text1Array</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$val</span>)&#123;<span class="comment">//统计该字在第一文本中出现的次数</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$textSumArray</span>[<span class="variable">$val</span>]))&#123;</span><br><span class="line">            <span class="variable">$textSumArray</span>[<span class="variable">$val</span>][<span class="number">0</span>]++;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$textSumArray</span>[<span class="variable">$val</span>][<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">            <span class="variable">$textSumArray</span>[<span class="variable">$val</span>][<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$text2Array</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$val</span>)&#123;<span class="comment">//统计该字在第二文本中出现的次数</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$textSumArray</span>[<span class="variable">$val</span>]))&#123;</span><br><span class="line">            <span class="variable">$textSumArray</span>[<span class="variable">$val</span>][<span class="number">1</span>]++;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$textSumArray</span>[<span class="variable">$val</span>][<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">            <span class="variable">$textSumArray</span>[<span class="variable">$val</span>][<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$sqdoc1</span> = <span class="number">0</span>;<span class="comment">//平方和</span></span><br><span class="line">    <span class="variable">$sqdoc2</span> = <span class="number">0</span>;<span class="comment">//平方和</span></span><br><span class="line">    <span class="variable">$denominator</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$textSumArray</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$val</span>)&#123;</span><br><span class="line">        <span class="variable">$denominator</span> += <span class="variable">$val</span>[<span class="number">0</span>] * <span class="variable">$val</span>[<span class="number">1</span>];</span><br><span class="line">        <span class="variable">$sqdoc1</span> += <span class="variable">$val</span>[<span class="number">0</span>] * <span class="variable">$val</span>[<span class="number">0</span>];</span><br><span class="line">        <span class="variable">$sqdoc2</span> += <span class="variable">$val</span>[<span class="number">1</span>] * <span class="variable">$val</span>[<span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$denominator</span> / sqrt(<span class="variable">$sqdoc1</span>*<span class="variable">$sqdoc2</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span><br><span class="line">* 分割字符串方法 （支持中文分割）</span><br><span class="line">* <span class="doctag">@author</span> juice</span><br><span class="line">* <span class="doctag">@param</span> str 需要分割的字符串</span><br><span class="line">* <span class="doctag">@param</span> charset 字符串的编码，默认UTF-8</span><br><span class="line">* <span class="doctag">@param</span> convertedToHex 是否返回该字符的16进制，TRUE返回每个字符16进制，FALSE则返回原本字符</span><br><span class="line">* <span class="doctag">@return</span> double 返回相似度(余弦值)</span><br><span class="line">*/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mbStringToArray</span><span class="params">(<span class="variable">$str</span> = <span class="string">''</span>,<span class="variable">$charset</span> = <span class="string">'UTF-8'</span> , <span class="variable">$convertedToHex</span> = FALSE)</span> </span>&#123;</span><br><span class="line">    <span class="variable">$strlen</span> = mb_strlen(<span class="variable">$str</span>);</span><br><span class="line">    <span class="keyword">if</span>( <span class="variable">$convertedToHex</span> === <span class="keyword">TRUE</span> )&#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="variable">$strlen</span>)&#123;</span><br><span class="line">            <span class="variable">$array</span>[] = bin2hex(mb_substr(<span class="variable">$str</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="variable">$charset</span>));</span><br><span class="line">            <span class="variable">$str</span> = mb_substr(<span class="variable">$str</span>,<span class="number">1</span>,<span class="variable">$strlen</span>,<span class="variable">$charset</span>);</span><br><span class="line">            <span class="variable">$strlen</span> = mb_strlen(<span class="variable">$str</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="variable">$strlen</span>)&#123;</span><br><span class="line">            <span class="variable">$array</span>[] = mb_substr(<span class="variable">$str</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="variable">$charset</span>);</span><br><span class="line">            <span class="variable">$str</span> = mb_substr(<span class="variable">$str</span>,<span class="number">1</span>,<span class="variable">$strlen</span>,<span class="variable">$charset</span>);</span><br><span class="line">            <span class="variable">$strlen</span> = mb_strlen(<span class="variable">$str</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$array</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="preprocessor">?&gt;</span></span><br></pre></td></tr></table></figure></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/原创/">原创</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-2013-09-curl-400-bad-request" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2013/09/09/2013-09-curl-400-bad-request/" class="article-date">
  	<time datetime="2013-09-09T09:30:00.000Z" itemprop="datePublished">2013-09-09</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2013/09/09/2013-09-curl-400-bad-request/">php curl请求返回400 Bad Request的解决方法</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&amp;nbsp;</span><br><span class="line"><span class="tag">&lt;<span class="title">h1</span>&gt;</span>400 Bad Request<span class="tag">&lt;/<span class="title">h1</span>&gt;</span></span><br><span class="line">&amp;nbsp;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="title">center</span>&gt;</span>nginx/1.2.0<span class="tag">&lt;/<span class="title">center</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>当你使用php的curl方法时会返回400 Bad Request，这有如下几种原因：</p>
<p>1.远端有检测客户端过滤行为。<br>2.远端有redir行为。<br>3.请求中间层。<br>4.近端有过滤行为。<br>5.某个过程有缓存机制。<br>6.脚本文件编码问题。</p>
<p>前面5种都是服务器的限制，做一些伪装就可以，但是很多人会忽略掉第六个原因，这是因为Unicode、Unicode big endian和UTF-8编码的txt文件的开头会多出几个字节，分别是FF、FE（Unicode）,FE、FF（Unicode big endian）,EF、BB、BF（UTF-8）。一般只要换成UTF-8编码就没有可以解决了。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/原创/">原创</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-2013-09-hijack-browser" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2013/09/05/2013-09-hijack-browser/" class="article-date">
  	<time datetime="2013-09-04T16:09:00.000Z" itemprop="datePublished">2013-09-05</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2013/09/05/2013-09-hijack-browser/">看我如何劫持用户的浏览器</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>标题起的有点大有点夸张，但应该引起重视，起因是我在搜索一个东西的时候，打开了一个垃圾站点，神奇的事情发生了，新标签打开这个站点后，我的Google搜索页面自动跳转到广告页面了，出于好奇必须研究一下，首先它控制了我的Google搜索页面，所以我猜测它代码里有“Google”这个关键词，在Chrome控制台用强大的ctrl+shift+f搜到了几个js文件，前面都是Google广告的js，最后一个js.js是咸鱼饭，于是在这个文件里找到可疑的被加密的代码位置下了个断点。</p>
<p><img src="http://i.wanz.im/wp-content/uploads/2013/07/evilcodes.png" alt="p1"></p>
<p>经过耐心一直按F11跟踪后，控制台VM输出了解密后的关键函数。<br><img src="http://i.wanz.im/wp-content/uploads/2013/07/decoded-evil-codes.png" alt="p2"></p>
<p>看到这里基本上就知道了垃圾站劫持搜索页面的方法了，代码很简单有点基础的同学应该都可以看懂，这时我的想法是这么简单，我怎么没想到，思路很重要，到这里代码分析及实现原理就这样完了，简单到没什么可以讲的了。</p>
<p>垃圾站用这样的方式来刷流量刷广告很正常，但是我想到的是更可怕的事情，被访问页面可以劫持用户的来源页面，也就产生了一个钓鱼攻击的利用场景：</p>
<p>1，用户A在微博看到一个链接好奇打开了；<br>2，被打开的页面evilA用一些吸引眼球的内容抓住用户的注意力；<br>3，微博页面被劫持跳转到钓鱼页面，例如一个假的高仿的微博页面evilB；<br>4，当用户关闭页面evilA，打算继续看微博的时候，此时他看到的是高仿的微博页面evilB，而用户没留意到页面已经被替换；<br>5，高仿的微博页面evilB提示登录超时，要求用户重新登录，用户输入帐号密码；<br>6，高仿的微博页面evilB记录用户密码后再跳回正常的微博页面，用户帐号在不知不觉中被盗；</p>
<p>测试页面：<a href="http://wanz.im/demo/referrer-hijacking.html" target="_blank" rel="external">http://wanz.im/demo/referrer-hijacking.html</a></p>
<p>Chrome 28.0.1500.72 m，Firefox 22.0成功劫持，IE 10.0.9200.16635提示没有权限</p>
<p>当然上述是理想状态下的钓鱼攻击，高端点的利用就是程序通过referrer信息立刻生成一个相同的页面来钓鱼，不注意防范依然有风险存在，上网需谨慎！</p>
<p>转载自：<a href="http://i.wanz.im/2013/07/19/hijacking-referrer-page/" target="_blank" rel="external">http://i.wanz.im/2013/07/19/hijacking-referrer-page/</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/转载/">转载</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/archives/2013/page/2/">2</a><a class="extend next" rel="next" href="/archives/2013/page/2/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2015 juice
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: false,
		isArchive: true,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>